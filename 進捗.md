# AIウェブサイトビルダー：進捗状況（実装同期版）

## 1. 現在地（要約）

- 取得→最適化→プレビュー→特徴量収集→AI分割までワンストップで実行可能
- 取得→最適化→プレビュー→特徴量収集→AI分割→タグ付けまでワンストップで実行可能
- CDNのCSSは維持、同一ホストCSSのみ未使用セレクタを削除してローカル差し替え
- ダミーテキスト置換は現時点で無効化（AIによる構造整理後に再検討）
- OpenAI API キーは `.env` から読み込み（`src/config.js`）

## 2. 実行フロー（npm scripts）

```bash
npm run scrape -- https://<URL>
npm run optimize -- <ホスト名>
npm run preview
npm run collect:features -- <ホスト名>
npm run ai:segment -- <ホスト名>
npm run tag -- <ホスト名>
```

- `package.json` scripts: `scrape`, `optimize`, `preview`, `collect:features`, `ai:segment`

## 3. 実装モジュール（@src/）

- `src/scrape.js`
  - PuppeteerでHTMLレンダリング取得、画像/動画/フォントはスキップ
  - `<link rel="stylesheet">` の元 `href` と `<style>` のIDを `css-manifest.json` に保存
  - 収集CSSは `styles/external-*.css` へ保存（HTMLの<link>は維持）

- `src/optimize.js`
  - リンクをダミー化（`<a href="#">`）
  - imgの `width/height` をstyleから安全に補完（px）
  - 未使用CSS削除（メディアクエリ/キーフレーム/コメント保持）。`.js-*`, `.is-*`, `.active` を safelist
  - 同一ホストのCSSのみ `styles/optimized-*.css` を生成し、HTML内の該当<link>をローカルに書換え
  - ダミーテキスト置換は現在停止
  - 出力: `index.optimized.html`, `structured.json`, `structured.yml`

- `src/collectFeatures.js`
  - ローカルプレビュー（`index.optimized.html` → `index.html`の順）へ接続
  - 主要候補ブロックの視覚特徴（BBox/可視/背景色/余白/見出し有無/テキスト要約など）を収集
  - 出力: `features.json`, `features.yml`

- `src/aiSegment.js`
  - OpenAI API（`gpt-4o-mini`）に `features.json` を渡し、視覚セクションに分割
  - 出力: `segments.json`, `segments.yml`
  - 設定: `src/config.js` が `.env` の `OPENAI_API_KEY` を読む

- `src/TagElements.js`
  - `index.optimized.html`（無ければ `index.html`）に対して、セクション候補に `data-section` と `data-targets`（JSON）を付与
  - `data-ai-*` は使わず、全要素を原則編集対象とする前提で、見出し/本文/画像/リンク/ボタン/フォーム/入力などの相対セレクタをまとめて格納
  - 出力: `index.tagged.html`

- `src/config.js`
  - `dotenv` により `.env` から `OPENAI_API_KEY` を読込（未設定/プレースホルダで実行停止）

## 4. 生成物（サンプル: `/output/micro-f.co.jp/`）

- 主要ファイル
  - `index.html`
  - `index.optimized.html`
  - `index.tagged.html`
  - `css-manifest.json`
  - `structured.json` / `structured.yml`
  - `features.json` / `features.yml`
  - `segments.json` / `segments.yml`

## 5. 補足ポリシー

- JS由来アニメーション等は初期フェーズで無効（レイアウト検証を優先）
- CDNリンクは維持し、同一ホストCSSのみ最適化の対象
- インラインstyleは保持（HTML書き換えせず）。`i`タグ等のアイコンフォントも保持
- ダミーテキストは現状未適用。倫理対応は構造整理後に再設計

## 6. 次の課題

- features → segments の品質改善（プロンプト/特徴量の拡充）
- セクションへ `data-*` 付与（`data-section`/`data-targets`）の拡張設計（選択子の網羅性・一意性向上）
- 変更適用パイプライン（自然言語指定 → DOM/CSS編集 → プレビュー差分）

## 7. 参照

- 仕様・工程: `02_optimize.md`
- 実行スクリプト: `package.json`
- 実装コード: `@src/`（`scrape.js`, `optimize.js`, `collectFeatures.js`, `aiSegment.js`, `config.js`）
